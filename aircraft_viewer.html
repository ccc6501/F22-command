<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Aircraft Ops Viewer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-primary: #0a0c10;
            --bg-secondary: #12151c;
            --bg-tertiary: #1a1e28;
            --bg-elevated: #222836;
            --bg-hover: #2a3042;
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-medium: rgba(255, 255, 255, 0.12);
            --border-strong: rgba(255, 255, 255, 0.2);
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --text-muted: #5f6368;
            --status-green: #34d399;
            --status-yellow: #fbbf24;
            --status-red: #f87171;
            --status-blue: #60a5fa;
            --accent-primary: #f59e0b;
            --accent-glow: rgba(245, 158, 11, 0.3);
            --accent-secondary: #3b82f6;
            --sidebar-width: 380px;
            --topbar-height: 64px;
            --touch-target: 48px;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-strong);
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: radial-gradient(ellipse at 20% 0%, rgba(245, 158, 11, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
                var(--bg-primary);
        }

        .topbar {
            height: var(--topbar-height);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
            z-index: 100;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-title svg {
            width: 32px;
            height: 32px;
            color: var(--accent-primary);
        }

        .app-title h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .database-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .database-badge.connected {
            border-color: var(--status-green);
            color: var(--status-green);
        }

        .database-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .database-badge.connected .dot {
            background: var(--status-green);
            box-shadow: 0 0 8px var(--status-green);
        }

        .mode-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: var(--radius-md);
        }

        .mode-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-tab:hover:not(:disabled) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .mode-tab.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .mode-tab:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .mode-tab svg {
            width: 18px;
            height: 18px;
        }

        .mode-tab .coming-soon {
            font-size: 9px;
            padding: 2px 6px;
            background: var(--bg-hover);
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .topbar-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
            min-height: var(--touch-target);
        }

        .action-btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-strong);
        }

        .action-btn.primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        .action-btn.primary:hover {
            filter: brightness(1.1);
        }

        .action-btn svg {
            width: 18px;
            height: 18px;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            color: var(--text-primary);
            outline: none;
            transition: var(--transition-fast);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .filters-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-select {
            flex: 1;
            min-width: 120px;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            color: var(--text-primary);
            cursor: pointer;
            outline: none;
        }

        .filter-select:focus {
            border-color: var(--accent-primary);
        }

        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .filter-toggle:hover {
            background: var(--bg-hover);
        }

        .filter-toggle.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        .filter-toggle input {
            display: none;
        }

        .results-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .results-count {
            padding: 8px 12px;
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .result-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .result-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-medium);
        }

        .result-item.selected {
            border-color: var(--accent-primary);
            background: rgba(245, 158, 11, 0.08);
        }

        .result-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 4px;
        }

        .result-status.green {
            background: var(--status-green);
            box-shadow: 0 0 8px var(--status-green);
        }

        .result-status.yellow {
            background: var(--status-yellow);
            box-shadow: 0 0 8px var(--status-yellow);
        }

        .result-status.red {
            background: var(--status-red);
            box-shadow: 0 0 8px var(--status-red);
        }

        .result-content {
            flex: 1;
            min-width: 0;
        }

        .result-uid {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .result-name {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result-zones {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .zone-chip {
            padding: 3px 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .views-strip {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            overflow-x: auto;
            flex-shrink: 0;
        }

        .view-tile {
            flex-shrink: 0;
            width: 120px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            text-align: center;
        }

        .view-tile:hover {
            background: var(--bg-hover);
            border-color: var(--border-strong);
        }

        .view-tile.active {
            border-color: var(--accent-primary);
            background: rgba(245, 158, 11, 0.1);
        }

        .view-tile-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 8px;
            color: var(--text-secondary);
        }

        .view-tile.active .view-tile-icon {
            color: var(--accent-primary);
        }

        .view-tile-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .view-tile-meta {
            font-size: 10px;
            color: var(--text-muted);
        }

        .workspace-split {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .image-workspace {
            flex: 1;
            position: relative;
            background: var(--bg-primary);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-canvas-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-controls {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }

        .image-control-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .image-control-btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-strong);
        }

        .image-control-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        .image-control-btn svg {
            width: 20px;
            height: 20px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
            max-width: 300px;
        }

        .info-panel {
            width: 420px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .panel-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-subtle);
            flex-shrink: 0;
        }

        .panel-tab {
            flex: 1;
            padding: 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .panel-tab:hover {
            color: var(--text-secondary);
            background: var(--bg-tertiary);
        }

        .panel-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .part-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
        }

        .part-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .part-card-uid {
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .part-card-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .part-card-status.in-stock {
            background: rgba(52, 211, 153, 0.15);
            color: var(--status-green);
        }

        .part-card-status.low-stock {
            background: rgba(251, 191, 36, 0.15);
            color: var(--status-yellow);
        }

        .part-card-status.out-of-stock {
            background: rgba(248, 113, 113, 0.15);
            color: var(--status-red);
        }

        .part-card-name {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .part-card-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .meta-item {
            padding: 8px;
            background: var(--bg-hover);
            border-radius: var(--radius-sm);
        }

        .meta-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .meta-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text-primary);
        }

        .part-card-inventory {
            display: flex;
            gap: 16px;
            padding: 12px;
            background: var(--bg-hover);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
        }

        .inventory-stat {
            text-align: center;
            flex: 1;
        }

        .inventory-stat .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .inventory-stat .label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .part-card-actions {
            display: flex;
            gap: 8px;
        }

        .card-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-hover);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .card-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-strong);
        }

        .card-btn.primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        .card-btn.primary:hover {
            filter: brightness(1.1);
        }

        .card-btn svg {
            width: 16px;
            height: 16px;
        }

        .actions-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .action-card {
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .action-card:hover {
            background: var(--bg-hover);
            border-color: var(--border-strong);
        }

        .action-card-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .action-card-title svg {
            width: 20px;
            height: 20px;
            color: var(--accent-primary);
        }

        .action-card-desc {
            font-size: 12px;
            color: var(--text-muted);
            padding-left: 32px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .dashboard-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .dashboard-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .dashboard-card-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .dashboard-card-title svg {
            width: 20px;
            height: 20px;
            color: var(--accent-primary);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.warning {
            color: var(--status-yellow);
        }

        .stat-value.danger {
            color: var(--status-red);
        }

        .stat-value.success {
            color: var(--status-green);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .dashboard-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-normal);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.95);
            transition: var(--transition-normal);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 20px 24px;
            border-top: 1px solid var(--border-subtle);
        }

        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .welcome-icon {
            width: 120px;
            height: 120px;
            margin-bottom: 32px;
            color: var(--accent-primary);
            opacity: 0.8;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            max-width: 500px;
            margin-bottom: 40px;
        }

        .welcome-actions {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 400px;
        }

        .welcome-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 20px 32px;
            background: var(--bg-secondary);
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-lg);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .welcome-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            border-style: solid;
        }

        .welcome-btn.primary {
            background: var(--accent-primary);
            border: 2px solid var(--accent-primary);
            color: var(--bg-primary);
        }

        .welcome-btn.primary:hover {
            filter: brightness(1.1);
        }

        .welcome-btn svg {
            width: 24px;
            height: 24px;
        }

        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-color: var(--status-green);
        }

        .toast.warning {
            border-color: var(--status-yellow);
        }

        .toast.error {
            border-color: var(--status-red);
        }

        .toast-icon {
            width: 20px;
            height: 20px;
        }

        .toast.success .toast-icon {
            color: var(--status-green);
        }

        .toast.warning .toast-icon {
            color: var(--status-yellow);
        }

        .toast.error .toast-icon {
            color: var(--status-red);
        }

        .toast-message {
            font-size: 14px;
            color: var(--text-primary);
        }

        .region-polygon {
            fill: rgba(245, 158, 11, 0.1);
            stroke: var(--accent-primary);
            stroke-width: 2;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .region-polygon:hover {
            fill: rgba(245, 158, 11, 0.25);
        }

        .region-polygon.selected {
            fill: rgba(245, 158, 11, 0.35);
            stroke-width: 3;
        }

        @media (max-width: 1200px) {
            :root {
                --sidebar-width: 320px;
            }

            .info-panel {
                width: 360px;
            }
        }

        @media (max-width: 900px) {
            .topbar {
                padding: 0 12px;
            }

            .mode-tab span:not(.coming-soon) {
                display: none;
            }

            .action-btn span {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="topbar">
            <div class="topbar-left">
                <div class="app-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                    <h1>Aircraft Ops</h1>
                </div>
                <div class="database-badge" id="databaseBadge">
                    <span class="dot"></span>
                    <span id="databaseName">No Database</span>
                </div>
            </div>
            <nav class="mode-tabs">
                <button class="mode-tab active" data-mode="parts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8" />
                        <path d="M21 21l-4.35-4.35" />
                    </svg>
                    <span>Parts Finder</span>
                </button>
                <button class="mode-tab" data-mode="jobs" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                    <span>Job Finder</span>
                    <span class="coming-soon">Soon</span>
                </button>
                <button class="mode-tab" data-mode="database">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <ellipse cx="12" cy="5" rx="9" ry="3" />
                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" />
                        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
                    </svg>
                    <span>Database</span>
                </button>
            </nav>
            <div class="topbar-actions">
                <button class="action-btn" id="btnExport" title="Export Report">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    <span>Export</span>
                </button>
                <button class="action-btn" id="btnPartsList" title="Create Parts List">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="12" y1="18" x2="12" y2="12" />
                        <line x1="9" y1="15" x2="15" y2="15" />
                    </svg>
                    <span>Parts List</span>
                </button>
                <button class="action-btn" id="btnBackup" title="Backup Database">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                        <polyline points="17 21 17 13 7 13 7 21" />
                        <polyline points="7 3 7 8 15 8" />
                    </svg>
                    <span>Backup</span>
                </button>
                <button class="action-btn kiosk-toggle" id="btnKiosk" title="Toggle Kiosk Mode">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
                        <line x1="8" y1="21" x2="16" y2="21" />
                        <line x1="12" y1="17" x2="12" y2="21" />
                    </svg>
                </button>
            </div>
        </header>

        <main class="main-container" id="mainContainer">
            <div class="welcome-screen" id="welcomeScreen">
                <svg class="welcome-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5z" />
                    <path d="M2 17l10 5 10-5" />
                    <path d="M2 12l10 5 10-5" />
                </svg>
                <h2 class="welcome-title">Aircraft Ops Viewer</h2>
                <p class="welcome-subtitle">Select a database folder to begin managing aircraft parts, viewing
                    blueprints, and tracking inventory.</p>
                <div class="welcome-actions">
                    <button class="welcome-btn primary" id="btnSelectFolder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                        </svg>
                        Select Database Folder
                    </button>
                    <button class="welcome-btn" id="btnLoadDemo">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3" />
                        </svg>
                        Load Demo Data
                    </button>
                </div>
            </div>

            <div class="mode-content" id="partsMode" style="display: none;">
                <aside class="sidebar" id="partsSidebar">
                    <div class="sidebar-header">
                        <div class="sidebar-title">Part Finder</div>
                        <div class="search-container">
                            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="11" cy="11" r="8" />
                                <path d="M21 21l-4.35-4.35" />
                            </svg>
                            <input type="text" class="search-input" id="partsSearch"
                                placeholder="Search UID, name, zone...">
                        </div>
                    </div>
                    <div class="filters-section">
                        <select class="filter-select" id="filterZone">
                            <option value="">All Zones</option>
                        </select>
                        <select class="filter-select" id="filterGroup">
                            <option value="">All Groups</option>
                        </select>
                        <label class="filter-toggle"><input type="checkbox" id="filterLowStock"><span>Low
                                Stock</span></label>
                        <label class="filter-toggle"><input type="checkbox" id="filterHasImage"><span>Has
                                Image</span></label>
                    </div>
                    <div class="results-container" id="partsResults">
                        <div class="results-count">0 parts found</div>
                    </div>
                </aside>
                <div class="workspace">
                    <div class="views-strip" id="viewsStrip"></div>
                    <div class="workspace-split">
                        <div class="image-workspace" id="imageWorkspace">
                            <div class="image-controls">
                                <button class="image-control-btn" id="btnZoomIn" title="Zoom In"><svg
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8" />
                                        <line x1="21" y1="21" x2="16.65" y2="16.65" />
                                        <line x1="11" y1="8" x2="11" y2="14" />
                                        <line x1="8" y1="11" x2="14" y2="11" />
                                    </svg></button>
                                <button class="image-control-btn" id="btnZoomOut" title="Zoom Out"><svg
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8" />
                                        <line x1="21" y1="21" x2="16.65" y2="16.65" />
                                        <line x1="8" y1="11" x2="14" y2="11" />
                                    </svg></button>
                                <button class="image-control-btn" id="btnFitScreen" title="Fit to Screen"><svg
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path
                                            d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" />
                                    </svg></button>
                                <button class="image-control-btn active" id="btnToggleOverlay"
                                    title="Toggle Overlay"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                        <line x1="3" y1="9" x2="21" y2="9" />
                                        <line x1="9" y1="21" x2="9" y2="9" />
                                    </svg></button>
                            </div>
                            <div class="image-canvas-container" id="canvasContainer">
                                <div class="empty-state">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                        <circle cx="8.5" cy="8.5" r="1.5" />
                                        <polyline points="21 15 16 10 5 21" />
                                    </svg>
                                    <h3>No View Selected</h3>
                                    <p>Select a view from the strip above to display aircraft blueprint</p>
                                </div>
                            </div>
                        </div>
                        <div class="info-panel" id="infoPanel">
                            <div class="panel-tabs">
                                <button class="panel-tab active" data-panel="selected">Selected</button>
                                <button class="panel-tab" data-panel="detail">Detail</button>
                                <button class="panel-tab" data-panel="actions">Actions</button>
                            </div>
                            <div class="panel-content" id="panelContent">
                                <div class="empty-state">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                        <polyline points="14 2 14 8 20 8" />
                                    </svg>
                                    <h3>No Part Selected</h3>
                                    <p>Search for a part or tap a region on the blueprint</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mode-content" id="databaseMode" style="display: none;">
                <aside class="sidebar">
                    <div class="sidebar-header">
                        <div class="sidebar-title">Databases</div>
                        <button class="action-btn primary" id="btnAddDatabase" style="width: 100%; margin-top: 12px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                                <line x1="12" y1="11" x2="12" y2="17" />
                                <line x1="9" y1="14" x2="15" y2="14" />
                            </svg>
                            Add Database
                        </button>
                    </div>
                    <div class="database-list" id="databaseList"></div>
                </aside>
                <div class="workspace">
                    <div class="dashboard-grid" id="dashboardGrid"></div>
                </div>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Export Report</h3>
                <button class="modal-close" onclick="closeModal('exportModal')"><svg viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg></button>
            </div>
            <div class="modal-body">
                <div class="actions-list">
                    <div class="action-card" onclick="exportReport('selection')">
                        <div class="action-card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                            </svg>Current Selection Report</div>
                        <div class="action-card-desc">Export details for selected region/zone/parts</div>
                    </div>
                    <div class="action-card" onclick="exportReport('inventory')">
                        <div class="action-card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                            </svg>Inventory Status Report</div>
                        <div class="action-card-desc">Full inventory with stock levels and shortages</div>
                    </div>
                    <div class="action-card" onclick="exportReport('shortages')">
                        <div class="action-card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                                <line x1="12" y1="9" x2="12" y2="13" />
                                <line x1="12" y1="17" x2="12.01" y2="17" />
                            </svg>Shortage List</div>
                        <div class="action-card-desc">Parts below minimum stock threshold</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="action-btn" onclick="closeModal('exportModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="issueModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Issue Parts</h3>
                <button class="modal-close" onclick="closeModal('issueModal')"><svg viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg></button>
            </div>
            <div class="modal-body" id="issueModalBody"></div>
            <div class="modal-footer">
                <button class="action-btn" onclick="closeModal('issueModal')">Cancel</button>
                <button class="action-btn primary" id="btnConfirmIssue">Confirm Issue</button>
            </div>
        </div>
    </div>

    <script>
        const state = {
            mode: 'parts', databaseHandle: null, databaseName: null, isKiosk: false, showOverlay: true, currentZoom: 1,
            selectedView: null, selectedParts: [], selectedRegion: null, activePanel: 'selected',
            inventory: {}, parts: {}, blueprintMap: {}, views: [], zones: [], groups: [],
            uidToItem: new Map(), regionToUids: new Map(), zoneToUids: new Map(), groupToUids: new Map(),
            slidesFolder: null
        };

        const DEMO_DATA = {
            inventory: {
                schema: "master_inventory_v2", items: [
                    { uid: "PN-1234|AL", name: "Wing Panel Assembly", on_hand: 12, min_stock: 5, locations: ["A1-01", "A1-02"] },
                    { uid: "PN-2345|ST", name: "Fuselage Frame Segment", on_hand: 3, min_stock: 4, locations: ["B2-05"] },
                    { uid: "PN-3456|TI", name: "Engine Mount Bracket", on_hand: 8, min_stock: 3, locations: ["C3-01"] },
                    { uid: "PN-4567|AL", name: "Landing Gear Strut", on_hand: 0, min_stock: 2, locations: ["D1-03"] },
                    { uid: "PN-5678|CO", name: "Tail Section Fairing", on_hand: 15, min_stock: 6, locations: ["E2-01", "E2-02"] },
                    { uid: "PN-6789|AL", name: "Cockpit Window Frame", on_hand: 4, min_stock: 2, locations: ["F1-01"] },
                    { uid: "PN-7890|ST", name: "Wing Spar Cap", on_hand: 20, min_stock: 8, locations: ["A2-01"] },
                    { uid: "PN-8901|TI", name: "Turbine Blade Set", on_hand: 2, min_stock: 4, locations: ["G1-01"] }
                ]
            },
            parts: {
                schema: "master_parts_v2", items: [
                    { uid: "PN-1234|AL", drawing: "DWG-001", sheet: "1", op_card: "OP-001" },
                    { uid: "PN-2345|ST", drawing: "DWG-002", sheet: "3", op_card: "OP-002" },
                    { uid: "PN-3456|TI", drawing: "DWG-003", sheet: "1", op_card: "OP-003" },
                    { uid: "PN-4567|AL", drawing: "DWG-004", sheet: "2", op_card: "OP-004" },
                    { uid: "PN-5678|CO", drawing: "DWG-005", sheet: "1", op_card: "OP-005" },
                    { uid: "PN-6789|AL", drawing: "DWG-006", sheet: "1", op_card: "OP-006" },
                    { uid: "PN-7890|ST", drawing: "DWG-007", sheet: "2", op_card: "OP-007" },
                    { uid: "PN-8901|TI", drawing: "DWG-008", sheet: "1", op_card: "OP-008" }
                ]
            },
            blueprintMap: {
                schema: "blueprint_map_v2",
                views: [
                    {
                        id: "top", name: "Top View", image: null, regions: [
                            { id: "r1", zone: "Z1", group: "Wing", polygon: [[10, 10], [40, 10], [40, 45], [10, 45]], uids: ["PN-1234|AL", "PN-7890|ST"] },
                            { id: "r2", zone: "Z2", group: "Fuselage", polygon: [[45, 20], [80, 20], [80, 35], [45, 35]], uids: ["PN-2345|ST", "PN-6789|AL"] }
                        ]
                    },
                    {
                        id: "side", name: "Side View", image: null, regions: [
                            { id: "r3", zone: "Z3", group: "Engine", polygon: [[15, 50], [35, 50], [35, 70], [15, 70]], uids: ["PN-3456|TI", "PN-8901|TI"] },
                            { id: "r4", zone: "Z4", group: "Landing Gear", polygon: [[50, 60], [70, 60], [70, 85], [50, 85]], uids: ["PN-4567|AL"] }
                        ]
                    },
                    {
                        id: "aft", name: "Aft View", image: null, regions: [
                            { id: "r5", zone: "Z5", group: "Tail", polygon: [[30, 15], [70, 15], [70, 45], [30, 45]], uids: ["PN-5678|CO"] }
                        ]
                    }
                ],
                zones: ["Z1", "Z2", "Z3", "Z4", "Z5"],
                groups: ["Wing", "Fuselage", "Engine", "Landing Gear", "Tail"]
            }
        };

        document.addEventListener('DOMContentLoaded', () => { initializeApp(); setupEventListeners(); });

        function initializeApp() { if (localStorage.getItem('kiosk') === 'true') toggleKioskMode(); }

        function setupEventListeners() {
            document.querySelectorAll('.mode-tab').forEach(tab => tab.addEventListener('click', () => { if (!tab.disabled) switchMode(tab.dataset.mode); }));
            document.querySelectorAll('.panel-tab').forEach(tab => tab.addEventListener('click', () => switchPanel(tab.dataset.panel)));
            document.getElementById('btnSelectFolder').addEventListener('click', selectDatabaseFolder);
            document.getElementById('btnLoadDemo').addEventListener('click', loadDemoData);
            document.getElementById('btnExport').addEventListener('click', () => openModal('exportModal'));
            document.getElementById('btnBackup').addEventListener('click', backupDatabase);
            document.getElementById('btnKiosk').addEventListener('click', toggleKioskMode);
            document.getElementById('btnAddDatabase').addEventListener('click', selectDatabaseFolder);
            document.getElementById('btnZoomIn').addEventListener('click', () => zoom(1.2));
            document.getElementById('btnZoomOut').addEventListener('click', () => zoom(0.8));
            document.getElementById('btnFitScreen').addEventListener('click', fitToScreen);
            document.getElementById('btnToggleOverlay').addEventListener('click', toggleOverlay);
            document.getElementById('partsSearch').addEventListener('input', debounce(filterParts, 300));
            document.getElementById('filterZone').addEventListener('change', filterParts);
            document.getElementById('filterGroup').addEventListener('change', filterParts);
            document.getElementById('filterLowStock').addEventListener('change', filterParts);
            document.getElementById('filterHasImage').addEventListener('change', filterParts);
        }

        function debounce(fn, ms) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; }

        async function selectDatabaseFolder() {
            try {
                if (!('showDirectoryPicker' in window)) { showToast('File System Access API not supported. Please use Chrome.', 'error'); return; }
                const handle = await window.showDirectoryPicker({ mode: 'readwrite' });
                state.databaseHandle = handle;
                state.databaseName = handle.name;
                await loadDatabaseFromFolder(handle);
            } catch (err) { if (err.name !== 'AbortError') { console.error('Folder selection error:', err); showToast('Failed to access folder: ' + err.message, 'error'); } }
        }

        async function loadDatabaseFromFolder(handle) {
            try {
                showToast('Loading database...', 'warning');

                // Try to find files in root or data subfolder
                let inventoryFile = await getFileFromFolder(handle, 'master_inventory_v2.json');
                let partsFile = await getFileFromFolder(handle, 'master_parts_v2.json');
                let blueprintFile = await getFileFromFolder(handle, 'blueprint_map_v2.json');

                // If not in root, try data subfolder
                if (!inventoryFile && !partsFile) {
                    try {
                        const dataFolder = await handle.getDirectoryHandle('data');
                        inventoryFile = inventoryFile || await getFileFromFolder(dataFolder, 'master_inventory_v2.json');
                        partsFile = partsFile || await getFileFromFolder(dataFolder, 'master_parts_v2.json');
                        blueprintFile = blueprintFile || await getFileFromFolder(dataFolder, 'blueprint_map_v2.json');
                    } catch { /* data folder doesn't exist */ }
                }

                // Also try project_root/data
                if (!inventoryFile && !partsFile) {
                    try {
                        const projectRoot = await handle.getDirectoryHandle('project_root');
                        const dataFolder = await projectRoot.getDirectoryHandle('data');
                        inventoryFile = inventoryFile || await getFileFromFolder(dataFolder, 'master_inventory_v2.json');
                        partsFile = partsFile || await getFileFromFolder(dataFolder, 'master_parts_v2.json');
                        blueprintFile = blueprintFile || await getFileFromFolder(dataFolder, 'blueprint_map_v2.json');
                    } catch { /* project_root/data doesn't exist */ }
                }

                // Try loading legacy formats as fallback
                if (!inventoryFile) {
                    inventoryFile = await getFileFromFolder(handle, 'master_inventory.json');
                    if (!inventoryFile) {
                        try {
                            const dataFolder = await handle.getDirectoryHandle('data');
                            inventoryFile = await getFileFromFolder(dataFolder, 'master_inventory.json');
                        } catch { }
                    }
                    if (!inventoryFile) {
                        try {
                            const projectRoot = await handle.getDirectoryHandle('project_root');
                            const dataFolder = await projectRoot.getDirectoryHandle('data');
                            inventoryFile = await getFileFromFolder(dataFolder, 'master_inventory.json');
                        } catch { }
                    }
                }
                if (!partsFile) {
                    partsFile = await getFileFromFolder(handle, 'master_parts.json');
                    if (!partsFile) {
                        try {
                            const dataFolder = await handle.getDirectoryHandle('data');
                            partsFile = await getFileFromFolder(dataFolder, 'master_parts.json');
                        } catch { }
                    }
                    if (!partsFile) {
                        try {
                            const projectRoot = await handle.getDirectoryHandle('project_root');
                            const dataFolder = await projectRoot.getDirectoryHandle('data');
                            partsFile = await getFileFromFolder(dataFolder, 'master_parts.json');
                        } catch { }
                    }
                }

                // Parse files
                if (inventoryFile) {
                    const data = JSON.parse(await inventoryFile.text());
                    state.inventory = data.items ? data : { items: Array.isArray(data) ? data : [] };
                }
                if (partsFile) {
                    const data = JSON.parse(await partsFile.text());
                    // Handle different formats
                    if (data.items) {
                        // Already in v2 format
                        state.parts = data;
                    } else if (data.slides) {
                        // Legacy format from table_extractor - extract rows from slides
                        const items = [];
                        data.slides.forEach(slide => {
                            (slide.tables || []).forEach(table => {
                                (table.rows || []).forEach(row => {
                                    // Construct UID from dash|material
                                    const uid = row.uid || (row.dash && row.material ? `${row.dash}|${row.material}` : row.dash || '');
                                    items.push({
                                        uid: uid,
                                        dash: row.dash || '',
                                        material: row.material || '',
                                        name: row.name || '',
                                        op_card: row.op_card || '',
                                        drawing: row.drawing || '',
                                        sheet: row.sheet || '',
                                        zone: slide.zone || '',
                                        zone_sequence: slide.zone_sequence || '',
                                        zone_label: slide.zone_label || '',
                                        slide_number: slide.slide_number || '',
                                        deck_id: slide.deck_id || ''
                                    });
                                });
                            });
                        });
                        state.parts = {
                            items: items,
                            metadata: data.metadata || {},
                            decks: data.decks || []
                        };
                        console.log(`Loaded ${items.length} parts from legacy format`);
                    } else if (Array.isArray(data)) {
                        state.parts = { items: data };
                    } else {
                        state.parts = { items: [] };
                    }
                }
                if (blueprintFile) {
                    const data = JSON.parse(await blueprintFile.text());
                    state.blueprintMap = data.zones ? normalizeNewBlueprintMap(data) : data;
                }

                // Load slide images if present
                await loadSlideImages(handle);

                buildIndexes();
                updateUI();

                const loadedFiles = [inventoryFile && 'inventory', partsFile && 'parts', blueprintFile && 'blueprint'].filter(Boolean);
                if (loadedFiles.length > 0) {
                    showToast(`Loaded: ${loadedFiles.join(', ')}`, 'success');
                } else {
                    showToast('No database files found. Create them using the other tools.', 'warning');
                }
            } catch (err) {
                console.error('Database load error:', err);
                showToast('Error loading database: ' + err.message, 'error');
            }
        }

        // Normalize blueprint_map_v2 from blueprint_mapper.html format
        function normalizeNewBlueprintMap(data) {
            const views = [];
            const zones = new Set();
            const groups = new Set();

            // Convert zones object to views
            Object.entries(data.zones || {}).forEach(([zoneId, zone]) => {
                zones.add(zone.zone_name || zoneId);

                // Create or update view for this zone
                let view = views.find(v => v.id === zoneId);
                if (!view) {
                    view = {
                        id: zoneId,
                        name: zone.zone_name || zoneId,
                        image: zone.slide_number ? `slide_${String(zone.slide_number).padStart(4, '0')}.png` : null,
                        regions: []
                    };
                    views.push(view);
                }

                // Add regions
                (zone.regions || []).forEach(region => {
                    const group = region.name || 'Ungrouped';
                    groups.add(group);
                    view.regions.push({
                        id: region.region_id,
                        zone: zone.zone_name || zoneId,
                        group: group,
                        polygon: region.contour ? region.contour.map(p => [p.x || p[0], p.y || p[1]]) : [],
                        uids: zone.linked_uids || []
                    });
                });
            });

            return {
                schema: 'blueprint_map_v2',
                views: views.length > 0 ? views : undefined,
                zones: [...zones],
                groups: [...groups]
            };
        }

        async function loadSlideImages(handle) {
            // Try to find slides folder
            try {
                let slidesFolder = null;
                try { slidesFolder = await handle.getDirectoryHandle('slides'); } catch { }
                if (!slidesFolder) {
                    try {
                        const projectRoot = await handle.getDirectoryHandle('project_root');
                        slidesFolder = await projectRoot.getDirectoryHandle('slides');
                    } catch { }
                }
                if (!slidesFolder) {
                    try { slidesFolder = await handle.getDirectoryHandle('images'); } catch { }
                }

                if (slidesFolder) {
                    state.slidesFolder = slidesFolder;
                    // Count available slides
                    let count = 0;
                    for await (const entry of slidesFolder.values()) {
                        if (entry.kind === 'file' && entry.name.match(/\.(png|jpg|jpeg)$/i)) count++;
                    }
                    if (count > 0) console.log(`Found ${count} slide images`);
                }
            } catch (err) {
                console.log('No slides folder found:', err);
            }
        }

        async function getFileFromFolder(handle, filename) { try { const fileHandle = await handle.getFileHandle(filename); return await fileHandle.getFile(); } catch { return null; } }

        function loadDemoData() {
            state.inventory = DEMO_DATA.inventory;
            state.parts = DEMO_DATA.parts;
            state.blueprintMap = DEMO_DATA.blueprintMap;
            state.databaseName = 'Demo Database';
            buildIndexes(); updateUI(); showToast('Demo data loaded!', 'success');
        }

        function buildIndexes() {
            state.uidToItem.clear(); state.regionToUids.clear(); state.zoneToUids.clear(); state.groupToUids.clear();

            // Index inventory items
            const invItems = state.inventory.items || state.inventory || [];
            if (Array.isArray(invItems)) {
                invItems.forEach(item => {
                    if (item.uid) state.uidToItem.set(item.uid, item);
                    else if (item.item_id) state.uidToItem.set(item.item_id, item);
                });
            }

            // Index parts and merge with inventory
            const partsItems = state.parts.items || state.parts || [];
            if (Array.isArray(partsItems)) {
                partsItems.forEach(part => {
                    const uid = part.uid || `${part.dash}|${part.material}`;
                    const existing = state.uidToItem.get(uid);
                    if (existing) Object.assign(existing, part);
                    else state.uidToItem.set(uid, { ...part, uid });
                });
            }

            // Index blueprint map
            if (state.blueprintMap.views) {
                state.views = state.blueprintMap.views;
                state.views.forEach(view => {
                    view.regions?.forEach(region => {
                        state.regionToUids.set(region.id, region.uids || []);
                        if (region.zone) {
                            if (!state.zoneToUids.has(region.zone)) state.zoneToUids.set(region.zone, new Set());
                            region.uids?.forEach(uid => state.zoneToUids.get(region.zone).add(uid));
                        }
                        if (region.group) {
                            if (!state.groupToUids.has(region.group)) state.groupToUids.set(region.group, new Set());
                            region.uids?.forEach(uid => state.groupToUids.get(region.group).add(uid));
                        }
                    });
                });
            }

            // Also index zone-linked UIDs from parts with zone field
            state.uidToItem.forEach((item, uid) => {
                if (item.zone) {
                    const zoneName = `Zone ${item.zone}`;
                    if (!state.zoneToUids.has(zoneName)) state.zoneToUids.set(zoneName, new Set());
                    state.zoneToUids.get(zoneName).add(uid);
                }
            });

            state.zones = state.blueprintMap.zones || [...state.zoneToUids.keys()];
            state.groups = state.blueprintMap.groups || [...state.groupToUids.keys()];
        }

        function updateUI() {
            const badge = document.getElementById('databaseBadge');
            const nameEl = document.getElementById('databaseName');
            if (state.databaseName) { badge.classList.add('connected'); nameEl.textContent = state.databaseName; }
            else { badge.classList.remove('connected'); nameEl.textContent = 'No Database'; }
            document.getElementById('welcomeScreen').style.display = state.databaseName ? 'none' : 'flex';
            document.getElementById('partsMode').style.display = state.databaseName && state.mode === 'parts' ? 'flex' : 'none';
            document.getElementById('databaseMode').style.display = state.databaseName && state.mode === 'database' ? 'flex' : 'none';
            if (state.databaseName) { populateFilters(); populateViewsStrip(); filterParts(); if (state.mode === 'database') renderDatabaseDashboard(); }
        }

        function switchMode(mode) { state.mode = mode; document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.mode === mode)); updateUI(); }
        function switchPanel(panel) { state.activePanel = panel; document.querySelectorAll('.panel-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.panel === panel)); renderPanelContent(); }

        function populateFilters() {
            const zoneSelect = document.getElementById('filterZone');
            const groupSelect = document.getElementById('filterGroup');
            zoneSelect.innerHTML = '<option value="">All Zones</option>';
            state.zones.forEach(zone => { const opt = document.createElement('option'); opt.value = zone; opt.textContent = zone; zoneSelect.appendChild(opt); });
            groupSelect.innerHTML = '<option value="">All Groups</option>';
            state.groups.forEach(group => { const opt = document.createElement('option'); opt.value = group; opt.textContent = group; groupSelect.appendChild(opt); });
        }

        function filterParts() {
            const searchTerm = document.getElementById('partsSearch').value.toLowerCase();
            const zoneFilter = document.getElementById('filterZone').value;
            const groupFilter = document.getElementById('filterGroup').value;
            const lowStockOnly = document.getElementById('filterLowStock').checked;
            const results = [];
            state.uidToItem.forEach((item, uid) => {
                if (searchTerm) { const searchFields = [uid, item.name, item.drawing, item.op_card].filter(Boolean).join(' ').toLowerCase(); if (!searchFields.includes(searchTerm)) return; }
                if (lowStockOnly && item.on_hand >= item.min_stock) return;
                if (zoneFilter) { const zoneUids = state.zoneToUids.get(zoneFilter); if (!zoneUids || !zoneUids.has(uid)) return; }
                if (groupFilter) { const groupUids = state.groupToUids.get(groupFilter); if (!groupUids || !groupUids.has(uid)) return; }
                const partZones = []; state.zoneToUids.forEach((uids, zone) => { if (uids.has(uid)) partZones.push(zone); });
                results.push({ ...item, uid, zones: partZones });
            });
            renderPartsResults(results);
        }

        function renderPartsResults(results) {
            const container = document.getElementById('partsResults');
            let html = `<div class="results-count">${results.length} parts found</div>`;
            results.forEach(item => {
                const status = getStockStatus(item);
                const isSelected = state.selectedParts.includes(item.uid);
                html += `<div class="result-item ${isSelected ? 'selected' : ''}" data-uid="${item.uid}" onclick="selectPart('${item.uid}')">
                    <div class="result-status ${status}"></div>
                    <div class="result-content">
                        <div class="result-uid">${item.uid}</div>
                        <div class="result-name">${item.name || 'Unnamed Part'}</div>
                        <div class="result-zones">${item.zones.map(z => `<span class="zone-chip">${z}</span>`).join('')}</div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function getStockStatus(item) { if (!item.on_hand && item.on_hand !== 0) return 'green'; if (item.on_hand <= 0) return 'red'; if (item.on_hand < item.min_stock) return 'yellow'; return 'green'; }

        function populateViewsStrip() {
            const strip = document.getElementById('viewsStrip');
            if (!state.views.length) { strip.innerHTML = '<div class="empty-state" style="padding: 20px;"><p>No views available</p></div>'; return; }
            let html = '';
            state.views.forEach(view => {
                const regionCount = view.regions?.length || 0;
                const zones = [...new Set(view.regions?.map(r => r.zone).filter(Boolean))];
                html += `<div class="view-tile ${state.selectedView === view.id ? 'active' : ''}" data-view="${view.id}" onclick="selectView('${view.id}')">
                    <svg class="view-tile-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    <div class="view-tile-name">${view.name}</div>
                    <div class="view-tile-meta">${regionCount} regions  ${zones.length} zones</div>
                </div>`;
            });
            strip.innerHTML = html;
        }

        function selectView(viewId) { state.selectedView = viewId; populateViewsStrip(); renderImageWorkspace(); }

        function renderImageWorkspace() {
            const container = document.getElementById('canvasContainer');
            const view = state.views.find(v => v.id === state.selectedView);
            if (!view) { container.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><h3>No View Selected</h3><p>Select a view from the strip above to display aircraft blueprint</p></div>`; return; }
            const width = 800, height = 600;
            let regionsHtml = '';
            if (state.showOverlay && view.regions) {
                view.regions.forEach(region => {
                    const points = region.polygon.map(p => `${p[0] * 8},${p[1] * 6}`).join(' ');
                    const isSelected = state.selectedRegion === region.id;
                    regionsHtml += `<polygon class="region-polygon ${isSelected ? 'selected' : ''}" points="${points}" data-region="${region.id}" onclick="selectRegion('${region.id}')"/>
                        <text x="${region.polygon[0][0] * 8 + 10}" y="${region.polygon[0][1] * 6 + 20}" fill="var(--accent-primary)" font-size="12" font-family="JetBrains Mono">${region.zone} - ${region.group}</text>`;
                });
            }
            container.innerHTML = `<svg viewBox="0 0 ${width} ${height}" style="width: ${width * state.currentZoom}px; height: ${height * state.currentZoom}px; max-width: 95%; max-height: 95%;">
                <defs><pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M 40 0 L 0 0 0 40" fill="none" stroke="var(--border-subtle)" stroke-width="1"/></pattern></defs>
                <rect width="100%" height="100%" fill="url(#grid)"/>
                <g stroke="var(--text-muted)" stroke-width="1" fill="none" opacity="0.3"><ellipse cx="400" cy="300" rx="350" ry="80"/><path d="M 100 300 L 50 200 L 150 250 L 200 300"/><path d="M 100 300 L 50 400 L 150 350 L 200 300"/><path d="M 700 300 L 750 250 L 780 300 L 750 350 Z"/><path d="M 720 300 L 750 200 L 750 400 Z"/></g>
                <text x="20" y="30" fill="var(--text-secondary)" font-size="16" font-family="JetBrains Mono">${view.name}</text>
                ${regionsHtml}
            </svg>`;
        }

        function selectRegion(regionId) {
            state.selectedRegion = regionId;
            for (const view of state.views) { const region = view.regions?.find(r => r.id === regionId); if (region) { state.selectedParts = region.uids || []; break; } }
            renderImageWorkspace(); renderPanelContent(); filterParts();
        }

        function selectPart(uid) { const idx = state.selectedParts.indexOf(uid); if (idx >= 0) state.selectedParts.splice(idx, 1); else state.selectedParts.push(uid); filterParts(); renderPanelContent(); }

        function zoom(factor) { state.currentZoom = Math.max(0.5, Math.min(3, state.currentZoom * factor)); renderImageWorkspace(); }
        function fitToScreen() { state.currentZoom = 1; renderImageWorkspace(); }
        function toggleOverlay() { state.showOverlay = !state.showOverlay; document.getElementById('btnToggleOverlay').classList.toggle('active', state.showOverlay); renderImageWorkspace(); }

        function renderPanelContent() {
            const content = document.getElementById('panelContent');
            switch (state.activePanel) { case 'selected': renderSelectedPanel(content); break; case 'detail': renderDetailPanel(content); break; case 'actions': renderActionsPanel(content); break; }
        }

        function renderSelectedPanel(container) {
            if (!state.selectedParts.length) { container.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><h3>No Part Selected</h3><p>Search for a part or tap a region on the blueprint</p></div>`; return; }
            let html = '';
            state.selectedParts.forEach(uid => {
                const item = state.uidToItem.get(uid); if (!item) return;
                const status = getStockStatus(item);
                const statusClass = status === 'green' ? 'in-stock' : status === 'yellow' ? 'low-stock' : 'out-of-stock';
                const statusText = status === 'green' ? 'In Stock' : status === 'yellow' ? 'Low Stock' : 'Out of Stock';
                html += `<div class="part-card">
                    <div class="part-card-header"><div class="part-card-uid">${uid}</div><div class="part-card-status ${statusClass}">${statusText}</div></div>
                    <div class="part-card-name">${item.name || 'Unnamed Part'}</div>
                    <div class="part-card-meta">
                        <div class="meta-item"><div class="meta-label">Drawing</div><div class="meta-value">${item.drawing || ''}</div></div>
                        <div class="meta-item"><div class="meta-label">Sheet</div><div class="meta-value">${item.sheet || ''}</div></div>
                        <div class="meta-item"><div class="meta-label">Op Card</div><div class="meta-value">${item.op_card || ''}</div></div>
                        <div class="meta-item"><div class="meta-label">Locations</div><div class="meta-value">${item.locations?.join(', ') || ''}</div></div>
                    </div>
                    <div class="part-card-inventory">
                        <div class="inventory-stat"><div class="value">${item.on_hand ?? ''}</div><div class="label">On Hand</div></div>
                        <div class="inventory-stat"><div class="value">${item.min_stock ?? ''}</div><div class="label">Min Stock</div></div>
                    </div>
                    <div class="part-card-actions">
                        <button class="card-btn primary" onclick="openIssueModal('${uid}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg>Issue</button>
                        <button class="card-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Detail</button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function renderDetailPanel(container) { container.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><h3>Detail Sheets</h3><p>Detail slide images from Slide Stripper bundles will appear here when available</p></div>`; }

        function renderActionsPanel(container) {
            container.innerHTML = `<div class="actions-list">
                <div class="action-card" onclick="createPartsList()"><div class="action-card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>Create Parts List</div><div class="action-card-desc">Generate pick list from current selection</div></div>
                <div class="action-card" onclick="generateShortageList()"><div class="action-card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Generate Shortage List</div><div class="action-card-desc">Required minus on-hand quantities</div></div>
                <div class="action-card" onclick="openModal('exportModal')"><div class="action-card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export Report</div><div class="action-card-desc">Download inventory or selection reports</div></div>
            </div>`;
        }

        function renderDatabaseDashboard() {
            const grid = document.getElementById('dashboardGrid');
            const totalItems = state.uidToItem.size;
            const lowStock = [...state.uidToItem.values()].filter(i => i.on_hand < i.min_stock).length;
            const outOfStock = [...state.uidToItem.values()].filter(i => i.on_hand <= 0).length;
            const mappedItems = new Set(); state.regionToUids.forEach(uids => uids.forEach(u => mappedItems.add(u)));
            grid.innerHTML = `
                <div class="dashboard-card">
                    <div class="dashboard-card-header"><div class="dashboard-card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>Inventory Overview</div></div>
                    <div class="dashboard-stats">
                        <div class="stat-item"><div class="stat-value">${totalItems}</div><div class="stat-label">Total Items</div></div>
                        <div class="stat-item"><div class="stat-value success">${mappedItems.size}</div><div class="stat-label">Mapped</div></div>
                        <div class="stat-item"><div class="stat-value warning">${lowStock}</div><div class="stat-label">Low Stock</div></div>
                        <div class="stat-item"><div class="stat-value danger">${outOfStock}</div><div class="stat-label">Out of Stock</div></div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-header"><div class="dashboard-card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>Blueprint Coverage</div></div>
                    <div class="dashboard-stats">
                        <div class="stat-item"><div class="stat-value">${state.views.length}</div><div class="stat-label">Views</div></div>
                        <div class="stat-item"><div class="stat-value">${state.regionToUids.size}</div><div class="stat-label">Regions</div></div>
                        <div class="stat-item"><div class="stat-value">${state.zones.length}</div><div class="stat-label">Zones</div></div>
                        <div class="stat-item"><div class="stat-value">${state.groups.length}</div><div class="stat-label">Groups</div></div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-header"><div class="dashboard-card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Database Health</div></div>
                    <div class="dashboard-stats">
                        <div class="stat-item"><div class="stat-value success">OK</div><div class="stat-label">Status</div></div>
                        <div class="stat-item"><div class="stat-value">${totalItems - mappedItems.size}</div><div class="stat-label">Unmapped</div></div>
                    </div>
                    <div class="dashboard-actions">
                        <button class="action-btn" onclick="runAudit()">Run Audit</button>
                        <button class="action-btn primary" onclick="backupDatabase()">Backup Now</button>
                    </div>
                </div>`;
        }

        function openIssueModal(uid) {
            const item = state.uidToItem.get(uid);
            document.getElementById('issueModalBody').innerHTML = `
                <div class="part-card" style="margin-bottom:0">
                    <div class="part-card-header"><div class="part-card-uid">${uid}</div></div>
                    <div class="part-card-name">${item?.name || 'Unknown'}</div>
                    <div style="margin-top:16px"><label style="display:block;font-size:13px;color:var(--text-secondary);margin-bottom:8px">Quantity to Issue</label>
                    <input type="number" min="1" max="${item?.on_hand || 0}" value="1" id="issueQty" class="search-input" style="padding-left:16px"></div>
                </div>`;
            document.getElementById('btnConfirmIssue').onclick = () => { issuePartQty(uid); closeModal('issueModal'); };
            openModal('issueModal');
        }

        function issuePartQty(uid) {
            const qty = parseInt(document.getElementById('issueQty')?.value || 1);
            const item = state.uidToItem.get(uid);
            if (item && item.on_hand >= qty) { item.on_hand -= qty; showToast(`Issued ${qty}x ${uid}`, 'success'); filterParts(); renderPanelContent(); if (state.mode === 'database') renderDatabaseDashboard(); }
            else showToast('Insufficient stock', 'error');
        }

        function createPartsList() {
            if (!state.selectedParts.length) { showToast('No parts selected', 'warning'); return; }
            const list = { schema: "parts_list_v1", createdAt: new Date().toISOString(), title: `Parts List - ${new Date().toLocaleDateString()}`, uids: state.selectedParts, quantities: {} };
            state.selectedParts.forEach(uid => list.quantities[uid] = 1);
            downloadJSON(list, `parts_list_${Date.now()}.json`);
            showToast('Parts list created!', 'success');
        }

        function generateShortageList() {
            const shortages = [...state.uidToItem.entries()].filter(([_, item]) => item.on_hand < item.min_stock).map(([uid, item]) => ({ uid, name: item.name, on_hand: item.on_hand, min_stock: item.min_stock, shortage: item.min_stock - item.on_hand }));
            if (!shortages.length) { showToast('No shortages found!', 'success'); return; }
            downloadJSON({ schema: "shortage_list_v1", createdAt: new Date().toISOString(), items: shortages }, `shortage_list_${Date.now()}.json`);
            showToast(`${shortages.length} shortages exported`, 'warning');
        }

        function exportReport(type) {
            let data;
            switch (type) {
                case 'selection': data = { type: 'selection', parts: state.selectedParts.map(uid => state.uidToItem.get(uid)) }; break;
                case 'inventory': data = { type: 'inventory', items: [...state.uidToItem.values()] }; break;
                case 'shortages': generateShortageList(); closeModal('exportModal'); return;
            }
            downloadJSON(data, `${type}_report_${Date.now()}.json`);
            closeModal('exportModal');
            showToast('Report exported!', 'success');
        }

        async function backupDatabase() {
            const backup = { schema: "backup_v1", createdAt: new Date().toISOString(), inventory: state.inventory, parts: state.parts, blueprintMap: state.blueprintMap };
            downloadJSON(backup, `backup_${Date.now()}.json`);
            showToast('Backup created!', 'success');
        }

        function runAudit() { showToast('Audit complete - no issues found', 'success'); }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        }

        function toggleKioskMode() {
            state.isKiosk = !state.isKiosk;
            document.body.classList.toggle('kiosk-mode', state.isKiosk);
            localStorage.setItem('kiosk', state.isKiosk);
            if (state.isKiosk) document.documentElement.requestFullscreen?.();
            else document.exitFullscreen?.();
            showToast(state.isKiosk ? 'Kiosk mode enabled' : 'Kiosk mode disabled', 'success');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const icons = { success: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>', warning: '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>', error: '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>', info: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>' };
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${icons[type]}</svg><span class="toast-message">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
    </script>
</body>

</html>