<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>F-22 Advanced Surveyor | Unified Bridge</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root {
            --neon: #00f0ff;
            --gold: #ffc800;
            --bg: #050508;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--neon);
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #viewer {
            flex: 1;
            position: relative;
            cursor: crosshair;
        }

        #sidebar {
            width: 380px;
            background: rgba(10, 15, 25, 0.95);
            border-left: 2px solid var(--neon);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .data-card {
            border: 1px solid var(--neon);
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(0, 240, 255, 0.05);
        }

        .log-item {
            font-size: 11px;
            padding: 8px;
            border-bottom: 1px solid rgba(0, 240, 255, 0.2);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .label {
            color: var(--gold);
            font-size: 10px;
            text-transform: uppercase;
        }

        #drop-zone {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px dashed var(--neon);
            padding: 40px;
            text-align: center;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <div id="viewer">
        <div id="drop-zone">DROP F-22 .GLB HERE</div>
    </div>

    <div id="sidebar">
        <h2 style="margin-top:0; letter-spacing: 2px;">SURVEYOR_v1.0</h2>

        <div id="inspection-panel" class="data-card">
            <div class="label">Current Inspection</div>
            <div id="active-part" style="font-size: 18px; margin: 10px 0;">READY FOR SCAN</div>
            <div id="part-meta" style="font-size: 12px; color: #fff;">Upload model to begin.</div>
        </div>

        <div class="label">Activity Feed</div>
        <div id="feed" style="flex: 1; overflow-y: auto; margin-top: 10px;"></div>
    </div>

    <script>
        // 1. DATA BRIDGE: These are your "known good" values from Blender
        const PART_REGISTRY = [
            { id: "5HY03205-111A", name: "Inlet Bleed Screen LH", uMin: 0.3250, uMax: 0.3600, vMin: 0.8179, vMax: 0.8600, op: "YY17201-01" },
            { id: "5HY03206-117A", name: "SOB to Bump LH", uMin: 0.1463, uMax: 0.2772, vMin: 0.0492, vMax: 0.3453, op: "YY17210-01" },
            { id: "DATUM_NOSE", name: "Nose Calibration Point", uMin: 0.3240, uMax: 0.3260, vMin: 0.8170, vMax: 0.8200, op: "CALIBRATION" }
        ];

        let scene, camera, renderer, controls, raycaster, mouse;

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 380) / window.innerHeight, 0.1, 1000);
            camera.position.set(5, 3, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth - 380, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('viewer').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            const point = new THREE.PointLight(0x00f0ff, 1);
            point.position.set(10, 10, 10);
            scene.add(ambient, point);

            window.addEventListener('mousedown', onSelect);
            setupFileDrop();
            animate();
        }

        function onSelect(event) {
            if (event.clientX > window.innerWidth - 380) return; // Ignore sidebar clicks

            mouse.x = (event.clientX / (window.innerWidth - 380)) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(scene.children, true);

            if (hits.length > 0) {
                const hit = hits[0];
                const uv = hit.uv;

                if (uv) {
                    // Spawn Visual Marker (The "Hit" Ring)
                    createHitMarker(hit.point);

                    // Search Registry for the Panel
                    const part = PART_REGISTRY.find(p =>
                        uv.x >= p.uMin && uv.x <= p.uMax &&
                        uv.y >= p.vMin && uv.y <= p.vMax
                    );

                    updateUI(part, uv);
                }
            }
        }

        function createHitMarker(position) {
            const ring = new THREE.Mesh(
                new THREE.RingGeometry(0.08, 0.1, 32),
                new THREE.MeshBasicMaterial({ color: 0x00f0ff, side: THREE.DoubleSide })
            );
            ring.position.copy(position);
            ring.lookAt(camera.position); // Face the user
            scene.add(ring);

            // Fade and Shrink animation
            let scale = 1;
            const interval = setInterval(() => {
                scale += 0.1;
                ring.scale.set(scale, scale, scale);
                ring.material.opacity -= 0.1;
                if (ring.material.opacity <= 0) {
                    scene.remove(ring);
                    clearInterval(interval);
                }
            }, 30);
        }

        function updateUI(part, uv) {
            const activeTitle = document.getElementById('active-part');
            const activeMeta = document.getElementById('part-meta');
            const feed = document.getElementById('feed');

            if (part) {
                activeTitle.innerText = part.name;
                activeTitle.style.color = "#00f0ff";
                activeMeta.innerHTML = `ID: ${part.id}<br>OP CARD: ${part.op}<br>UV: ${uv.x.toFixed(3)}, ${uv.y.toFixed(3)}`;

                const log = document.createElement('div');
                log.className = 'log-item';
                log.innerHTML = `<span style="color:var(--gold)">[HIT]</span> ${part.id} detected at UV mapping.`;
                feed.prepend(log);
            } else {
                activeTitle.innerText = "UNKNOWN PANEL";
                activeTitle.style.color = "#ff3366";
                activeMeta.innerText = `UV Location: ${uv.x.toFixed(4)}, ${uv.y.toFixed(4)} (Unmapped)`;
            }
        }

        function setupFileDrop() {
            window.addEventListener('dragover', e => e.preventDefault());
            window.addEventListener('drop', e => {
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if (file.name.endsWith('.glb')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const loader = new THREE.GLTFLoader();
                        loader.parse(event.target.result, '', (gltf) => {
                            scene.add(gltf.scene);
                            document.getElementById('drop-zone').style.display = 'none';
                            const log = document.createElement('div');
                            log.className = 'log-item';
                            log.innerHTML = `<span style="color:#00ff88">[SYS]</span> Model Loaded Successfully.`;
                            document.getElementById('feed').prepend(log);
                        });
                    };
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>

</html>